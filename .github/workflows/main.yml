name: Deploy to VPS

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create deployment package
        run: |
          printf "node_modules\n.git\n.github\n.env\n.env.local\n.env.development\n.env.test\nREADME.md\n.gitignore\n.deployignore\n" > .deployignore

          ls -la .deployignore

          tar \
            --exclude-from=.deployignore \
            --warning=no-file-changed \
            --ignore-failed-read \
            -czf deploy.tar.gz .


      - name: Install dependencies
        run: npm install

      - name: Build Next.js App
        run: npm run build

      - name: Create deployment package
        run: |
          printf "node_modules\n.git\n.github\n.env\n.env.local\n.env.development\n.env.test\nREADME.md\n.gitignore\n.deployignore\n" > .deployignore

          tar --warning=no-file-changed \
              --exclude-from=.deployignore \
              -czf deploy.tar.gz . || true
      - name: Upload deployment package
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy.tar.gz"
          target: "/home/souqza/"
          overwrite: true

      - name: Create .env file on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/souqza/app

            # Create .env file with secrets
            cat > .env << EOF
            DATABASE_URL="${{ secrets.DATABASE_URL }}"
            JWT_SECRET="${{ secrets.JWT_SECRET }}"
            RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"
            NEXT_PUBLIC_APP_URL="${{ secrets.NEXT_PUBLIC_APP_URL }}"
            EMAIL_FROM="${{ secrets.EMAIL_FROM }}"
            NODE_ENV=production
            EOF

            # Secure the .env file
            chmod 600 .env

      - name: Deploy and Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/souqza

            # Extract deployment package
            tar -xzf deploy.tar.gz -C app/
            rm deploy.tar.gz

            cd app

            # Verify .next directory exists
            if [ ! -d ".next" ]; then
              echo "Error: .next directory not found!"
              exit 1
            fi

            # Install production dependencies (including dotenv for Prisma)
            npm install --omit=dev


            # Generate Prisma client
            npx prisma generate

            # Run migrations
            npx prisma migrate deploy

            # Stop PM2 process if running
            pm2 stop souqza || true
            pm2 delete souqza || true

            # Start application with PM2
            pm2 start npm --name "souqza" -- start

            # Save PM2 configuration
            pm2 save

            # Show status
            echo "Deployment completed!"
            pm2 status
            pm2 logs souqza --lines 10 --nostream
